{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Inventsoft - Registro</title>
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="{% static 'css/home.css' %}">
    <link rel="stylesheet" href="{% static 'css/form.css' %}">
    <link rel="stylesheet" href="{% static 'css/modal.css' %}">
    <link href="https://fonts.googleapis.com/css?family=Sarabun:200,300,400,700,800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
</head>

<body>
    {% csrf_token %}
</body>

<script src="{% static 'js/design_patterns/factoryUserView.js' %}"></script>
<script src="{% static 'js/design_patterns/singletonUser.js' %}"></script>
<script src="{% static 'js/templates/nav.js' %}"></script>
<script src="{% static 'js/templates/forms.js' %}"></script>
<script src="{% static 'js/functions.js' %}"></script>
<script src="{% static 'js/styleFunctions.js' %}"></script>
<script src="{% static 'js/cleave.js' %}"></script>

<script>
    (async function(){

    // ------------------------------------------------
        // get user
        const user = await getSingleton();
        
    // ------------------------------------------------
        // Get nav specific options for that user type
        document.body.innerHTML += ViewNav(user);

    // ------------------------------------------------
        // Get form specific options for that form type
        document.body.innerHTML += factoryFormView(getFormType());

        if(getFormType() === '/form-products/'){

            let privateProductStorage = "";
            
            async function getCatAndProvData() {
                const response = await fetch('/categories_and_providers/');
                const data = await response.json();
                return data;
            }

            const data = await getCatAndProvData()

            function setAttributes(element, attributes){
                for(const attribute in attributes){
                    element.setAttribute(attribute, attributes[attribute])
                }
            }

            function addOptions(selectName, data){
                selectElement = document.getElementById(selectName);

                for(let i = 0; i < data.length; i++){
                    const optionElement = document.createElement('option');
                    setAttributes(optionElement, {
                        value: data[i].key,
                    }) 
                    optionElement.innerHTML = data[i].name;
                    selectElement.appendChild(optionElement);
                }
            }

            addOptions('categoria', data.categories);
            addOptions('proveedor', data.providers);

            const precio = new Cleave('#precio', {
                blocks: [10],
                uppercase: true
            });

            const cantidad = new Cleave('#cantidad', {
                blocks: [10],
                uppercase: true
            });

            const FORMPRODUCTO = document.querySelector('#formProducto');
            const CSRF_TOKEN = document.getElementsByName('csrfmiddlewaretoken')[0].value;

            async function mandarData(url, data){
                const response = await fetch(url, {
                    method: 'POST',
                    body: data,
                    headers: {
                        'X-CSRFToken': CSRF_TOKEN
                    }
                })
                const resp = await response.json();
                return resp;
            }
            

            if(localStorage.getItem('productKey')){
                privateProductStorage = localStorage.getItem('productKey');

                let titulo = document.getElementsByClassName('result-title')[0];
                console.log(titulo)
                titulo.innerHTML = '';
                titulo.innerHTML = '<h2>Editar Producto</h2>';

                async function getProductData() {
                    const response = await fetch(`/fetch_product/${privateProductStorage}/`);
                    const data = await response.json();
                    return data.product;
                }

                privateProductStorage = await getProductData();

                document.getElementById("nombre").value = privateProductStorage.name;
                document.getElementById("descripcion").value = privateProductStorage.description;
                document.getElementById("precio").value = privateProductStorage.price;
                document.getElementById("categoria").value = privateProductStorage.category;
                document.getElementById("proveedor").value = privateProductStorage.provider;
                document.getElementById("cantidad").value = privateProductStorage.amount;
            }

            FORMPRODUCTO.addEventListener('submit', async (e) => {
                e.preventDefault();

                if(document.getElementById('nombre').value !== '' && document.getElementById('descripcion').value !== '' && document.getElementById('precio').value !== '' && document.getElementById('categoria').value !== '' && document.getElementById('proveedor').value !== '' && document.getElementById('cantidad').value !== ''){
                    const form = new FormData();
                    if (privateProductStorage){
                    }
                    form.append('nombre', document.getElementById('nombre').value);
                    form.append('descripcion', document.getElementById('descripcion').value);
                    form.append('precio', document.getElementById('precio').value);
                    form.append('categoria', document.getElementById('categoria').value);
                    form.append('proveedor', document.getElementById('proveedor').value);
                    form.append('cantidad', document.getElementById('cantidad').value);
                    if (privateProductStorage){
                        console.log('si')
                        form.append('accion', 'EDIT');
                        form.append('id', privateProductStorage.product_key);
                    } else {
                        form.append('accion', 'NEW');
                    }

                    try {
                        const data = await mandarData('http://127.0.0.1:8000/post_product/', form);
                        if (data.status === 200) {
                            if (privateProductStorage){
                                localStorage.removeItem('productKey')
                                showModal('Producto actualizado <br> correctamente', 'fas fa-check-circle', '/products/');
                            } else{
                                showModal('Producto registrado <br> correctamente', 'fas fa-check-circle', '/products/');
                            }
                        } else {
                            showModal('Ocurri√≥ un error, <br> intenta de nuevo', 'fas fa-times',);
                        }
                    } catch (error) {
                        
                    }

                } else {
                    alert('Llenar todos los campos')
                }
        })

        console.log(privateProductStorage.category);
        } else if(getFormType() === '/form-sales/') {
            alert('SALES')
        }
    })();

</script>

</html>